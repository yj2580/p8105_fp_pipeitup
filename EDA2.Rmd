---
title: "Prevalence trend and Determinants of Suicide Rates"
author: "Team Pipeitup"
output: html_document
---

```{r,include=FALSE,message=FALSE,echo=FALSE}
library(tidyverse)
library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)

maindata <- read_csv("maindata.csv") %>% filter(year!=2016) %>% select(-1,-9,-14)
```

# Background

According to the World Health Organization, every year, about 800,000 people die due to suicide. In this project, we are wondering the trend of suicide rate across years. 

# Data

The main dataset for our project is a combined dataset from summary datasets made by United Nations Development Program, World Bank, Kaggle, and World Health Organization. It can be access at [here](https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016). The dataset has a size of `r nrow(maindata)` observations and `r ncol(maindata)` features. Features include:

- **Country**
- **Year**: Year of the records
- **Sex**:
- **Age**: Age groups including "5-14", "15-24",  "25-34", "35-54", "55-74", and "75+".
- **Suicides_no**: Amount of suicides
- **Population**
- **Suicides_100k_pop**: Amount of suicides over 100k
- **Gdp_for_year**: GDP for a given year
- **suicideRate**: Suicide Rate

# Exploratory data analysis (EDA)




# General Findings

## Trend of Global Suicide Rate over time 

Before 1995, the suicide rate at the global level is increasing, but since then, it keeps decreasing.

```{r,echo=FALSE,fig.align='center',fig.height=7,fig.width=10}
p <- maindata %>%
  group_by(year) %>%
  summarize(population = sum(population), 
            suicides = sum(suicides_no), 
            suicides_per_100k = (suicides / population) * 100000) %>%
  ggplot(aes(x = as.factor(year), y = suicides_per_100k, group=1)) + 
  geom_line(col = "deepskyblue3", size = 1) + 
  geom_point(col = "deepskyblue3", size = 2) + 
  labs(title = "Global Suicide Rates",
       subtitle = "1985 - 2015.",
       x = "Year", 
       y = "Suicide Rate") +
  theme(axis.text.x = element_text(angle = 45))

p + transition_reveal(year)
```

## trend with sex

We found that surprisingly, male has higher rate of suicide than female since 1985. Female suicide rate has a very stable trend throughout the history, while there were dramatic changes for male.

```{r}
p <- maindata%>%
  group_by(year, sex) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000) %>%
  ggplot(aes(x = year, y = suicide_per_100k, col = factor(sex))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Trends Over Time, by Sex", 
       x = "Year", 
       y = "Suicides per 100k", 
       color = "Sex") + 
  scale_x_continuous(breaks = seq(1985, 2015, 5), minor_breaks = F)


p + transition_reveal(year)
```

## trend with age

Suicide rates for the youngest age group nearly constant  and low over time. As the graph shown, elder groups have had higher suicide rate since 1985, and surprisingly such trend has not changed once.


```{r}
p <- maindata %>% group_by(year, age) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000) %>% 
  ggplot(aes(year, suicide_per_100k, fill = age)) +
  geom_density(stat = "identity",alpha=0.2) +
  labs(y = "Suicide rate", title = "Suicide rates across age group over time")

p
```


## Suicide Rate by Country GDP

GDP has been viewed as a good measure about the development of a country. However, graph below shows that there are no obvious trend between GDP and suicide rate. Although GDPs across the world have been shifted toward larger direction, such trend persists.

```{r,echo=FALSE}
interactiveplot = maindata %>%
  select(gdp_per_capita,suicides_100k_pop, suicideRate, year, country,population) %>% 
        ggplot(aes(x = gdp_per_capita, 
                   y = suicideRate,
                   size = population,
                   frame = year,
                   group = country)) +
        geom_point(colour='#1050DC') +
        scale_x_log10() + 
        scale_alpha_continuous(range = c(0.4, 0.8)) + 
        labs(title= "Suicide rates grouped by country from 1985 to 2016") +
#        geom_hline(aes(yintercept = mean(suicides_per_100k)), color="gray") +
        theme_minimal() +
        xlab("GDP") +
        ylab("Suicide Rate")

plotly = ggplotly(interactiveplot, tooltip = c('country', 'population', 'suicides_per_100k', 'gdp_per_capita'))
plotly
```

## Countries with most suicides across the years

```{r}

suicide_sub<-maindata %>% select(country,year,sex,suicides_no)


n<-unique(suicide_sub$country)
country<-function(x){
  suicide2<-suicide_sub %>% filter(country==x)
  sum(suicide2$suicides_no)
}

country_total<-sapply(n,function(x) country(x))

df<-do.call(rbind,Map(data.frame,Country=n,Total_Suicides=country_total))
df2<-df %>% arrange(desc(Total_Suicides))
df3<-head(df2,n=10)

top_suicide<-suicide_sub %>% filter(country==c('Russian Federation',
                                               'United States',
                                               'Japan','France',
                                               'Ukraine',
                                               'Germany',
                                               'Republic of Korea',
                                               'Brazil',
                                               'Poland',
                                               'United Kingdom'))

top_suicide2<-top_suicide
top_suicide2$sex<-as.factor(top_suicide2$sex)

sm3<-aggregate(suicides_no~country+year,top_suicide2,sum)

sm4<-sm3 %>% group_by(year) %>% mutate(rank = min_rank(-suicides_no) * 1) %>%
 ungroup()

static_plot<-ggplot(sm4,aes(rank,group=country,fill=as.factor(country),color=as.factor(country))) +
 geom_tile(aes(y = suicides_no/2,height = suicides_no, width = 0.9), alpha = 0.8, color = NA) +
 geom_text(aes(y = 0, label = paste(country, ' ')), vjust = 0.2, hjust = 1) +
 geom_text(aes(y=suicides_no,label = paste(' ',suicides_no)), hjust=0)+
 coord_flip(clip = 'off', expand = TRUE) +
 scale_y_continuous(labels = scales::comma) +
 scale_x_reverse() +
 guides(color = FALSE, fill = FALSE) +
 theme_minimal() +
 theme(
 plot.title=element_text(size=25, hjust=0.5, face='bold', colour='grey', vjust=-1),
 plot.subtitle=element_text(size=18, hjust=0.5, face='italic', color='grey'),
 plot.caption =element_text(size=8, hjust=0.5, face='italic', color='grey'),
 axis.ticks.y = element_blank(), 
 axis.text.y = element_blank(), 
 plot.margin = margin(1,1,1,4, 'cm')
 )

plt<-static_plot + transition_states(states = year, transition_length = 4, state_length = 1) + 
 ease_aes('cubic-in-out') +
 #view_follow(fixed_x = TRUE) +
 labs(title = 'Total Suicides per Year : {closest_state}', 
 subtitle = 'Top 10 Countries',
 caption = 'Data Source: World Bank Data',
 x='Countries',y='Total Suicides per year')

final_animation<-animate(plt,100,fps = 20,duration = 30, width = 950, height = 750, renderer = gifski_renderer())

final_animation
```


## Inference

### correlation for numeric variables

```{r}
# From the correlation plot on numeric variables, we can see that there are correlation between gdp for year, gdp per capita and population because the calculation of gdp per capita. Thus, in the model we included both gdp indicators but not the population because we think these two represents different things for comparison between countries.

# cannot run 
# errir nessgae:  Error in cor(corr_data) : 'x' must be numeric
#corr_data = maindata %>% 
#  select(-c(1,3,4,8,11,12,13)) 
#corr= cor(corr_data)
#corrplot(corr, type = "upper", order = "hclust", 
#         tl.col = "black", tl.srt = 45)
```

```{r}
# summary(maindata)
hist(maindata$suicides_100k_pop)
hist(maindata$gdp_for_year)
suicide = maindata %>% 
  mutate(suicides_100k_pop = suicides_100k_pop+1)
```


From the distribution plot of suicide_100k_pop, we can see that we need to transform it to satisfy the assumptions for linear model. we used log transformation and changed 0's to 0.01 for further calculations. Following graphs show the effect of transformation. 

```{r}
hist(log(maindata$suicides_100k_pop))
```



### bigger model



```{r}
maindata_try = maindata %>% 
  mutate(log_suicide =log(suicides_100k_pop))
maindata_try$log_suicide[is.infinite(maindata_try$log_suicide)]=0.01

model1=lm(log_suicide~year+sex*age+gdp_per_capita, data = maindata_try)

plot(model1)
summary(model1)
```







