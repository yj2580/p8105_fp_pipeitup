---
title: "Prevalence Trend of Suicide Commitments"
author: "Team Pipeitup"
output: html_document
fontsize: 12pt
---

```{r,include=FALSE,message=FALSE,echo=FALSE}

library(tidyverse)
library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)
library(kableExtra)
knitr::opts_chunk$set(
 echo = FALSE,
 fig.width = 8, 
 fig.height = 6,
 fig.asp = 0.6,
 out.width = "80%")
theme_set(theme_bw() + 
          theme(legend.position = "bottom",
                legend.title = element_blank(),
                plot.title = element_text(hjust = 0.5, size = 15),
                plot.subtitle = element_text(hjust = 0.5, size = 12)))

maindata <- read_csv("maindata.csv")
```

# Introduction

According to the World Health Organization, every year, about 800,000 people die due to suicide. In this project, with a joint dataset from United Nations Development Program, World Bank, Kaggle, and World Health Organization, we examined current trend of Suicide Commitmennts. In particular, we are intrested in:

- What's the general trend of suicide rate globally across the time.
- Is there any gender difference in suicide rate across the time.
- Is there any age difference in suicide rate across the time.
- the relationship between the development of a country (GDP) and suicide rate across time.

# Data

The main dataset for our project is a combined dataset from summary datasets made by United Nations Development Program, World Bank, Kaggle, and World Health Organization. It can be access at [here](https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016). This dataset has a range from 1985 to 2016. However, since there are very few data in 2016, we will only keep the range from 1985 to 2015. The raw dataset has a size of `r nrow(maindata)` observations and `r ncol(maindata)` features. Basic features we are interested in include:

- **Country**
- **Year**: Year of the records
- **Sex**:
- **Age**: Age groups including "5-14", "15-24",  "25-34", "35-54", "55-74", and "75+".
- **Suicides_no**: Amount of suicides

Besides those, we will derive our main interested variable, **Suicides Per 100K** as **Suicides_no** divided by **Population** and mutiplied by 100,000. The sample of the final dataset is shown below:

```{r,echo=FALSE}
kable(head(maindata))
```


# Statistical Analysis

Regression analysis will be the main method in our study.

# Results

## Global Trend of Suicide Per 100k Populationn over time 

Before 1995, the suicide rate at the global level is increasing, but since then, it keeps decreasing. The peak of the suicide rate among those 30 years was 1995.

```{r,echo=FALSE,fig.align='center',fig.height=7,fig.width=10}
p <- maindata %>%
  group_by(year) %>%
  summarize(population = sum(population), 
            suicides = sum(suicides_no), 
            suicides_per_100k = (suicides / population) * 100000) %>%
  ggplot(aes(x = as.factor(year), y = suicides_per_100k, group=1)) + 
  geom_line(col = "deepskyblue3", size = 1) + 
  geom_point(col = "deepskyblue3", size = 2) + 
  labs(title = "Global Suicide Rates",
       subtitle = "1985 - 2015.",
       x = "Year", 
       y = "Suicide Rate") +
  theme(axis.text.x = element_text(angle = 45))

p + transition_reveal(year)
```

## Global Trend of Suicide Per 100k Populationn by gender over time 

We found that surprisingly, male has higher rate of suicide than female since 1985. Female suicide rate has a very stable trend throughout the history, while there were dramatic changes for male. As mentioned in the other graph, there is a peak in 1995 for the suiceide rate.

```{r}
p <- maindata%>%
  group_by(year, sex) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000) %>%
  ggplot(aes(x = year, y = suicide_per_100k, col = factor(sex))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Trends Over Time, by Sex", 
       x = "Year", 
       y = "Suicides per 100k", 
       color = "Sex") + 
  scale_x_continuous(breaks = seq(1985, 2015, 5), minor_breaks = F)

p + transition_reveal(year)
```

## Global Trend of Suicide Per 100k Populationn by age over time 

Suicide rates for the youngest age group nearly constant  and low over time. As the graph shown, elder groups have had higher suicide rate since 1985, and surprisingly such trend has not changed once. For age groups 25-34, 35-54 and 55-74 had similar trends over those 30 years.


```{r}
p <- maindata%>%
  group_by(year, age) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000) %>%
  ggplot(aes(x = year, y = suicide_per_100k, col = factor(age))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Trends Over Time, by Sex", 
       x = "Year", 
       y = "Suicides per 100k", 
       color = "Sex") + 
  scale_x_continuous(breaks = seq(1985, 2015, 5), minor_breaks = F)

p + transition_reveal(year)
```


## Suicide Rate by Country GDP

GDP has been viewed as a good measure about the development of a country. However, graph below shows that there are no obvious trend between GDP and suicide rate. Although GDPs across the world have been shifted toward larger direction, such trend persists.

```{r,echo=FALSE}
p <- ggplot(maindata, aes(x = gdp_per_capita, y=suicide_per_100k, size = suicides_no, colour = country)) +
  geom_point(show.legend = FALSE, alpha = 0.7) +
  scale_color_viridis_d() +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  labs(x = "GDP per capita", y = "suicides_100k_pop")

p + transition_time(year) + labs(title = "Year: {frame_time}") + shadow_wake(wake_length = 0.1, alpha = FALSE)
```
After seen the trends, we researched about the year 1995 and ...


## Countries with most suicides across the years

We can see that United States, Russian Federation and Japan are the top 3 countries with highest suicides per year. US, Japan, and Germany (number 4 in the rank) have highest GDP rank as well. After researching, Russian Federation has high suicide rate might due to heavy alcoholic use, with an estimated half of all suicides correlated with alcohol abuse.

```{r,echo=FALSE}

suicide_sub<-maindata %>% select(country,year,sex,suicides_no)


n<-unique(suicide_sub$country)
country<-function(x){
  suicide2<-suicide_sub %>% filter(country==x)
  sum(suicide2$suicides_no)
}

country_total<-sapply(n,function(x) country(x))

df<-do.call(rbind,Map(data.frame,Country=n,Total_Suicides=country_total)) %>% arrange(desc(Total_Suicides)) %>% head(df2,n=10)

top_suicide<- suicide_sub %>% filter(country %in% c('Russian Federation',
                                               'United States',
                                               'Japan',
                                               'France',
                                               'Ukraine',
                                               'Germany',
                                               'Republic of Korea',
                                               'Brazil',
                                               'Poland',
                                               'United Kingdom'))

top_suicide$sex<-as.factor(top_suicide$sex)

sm3<-aggregate(suicides_no~country+year,top_suicide,sum) %>% 
  group_by(year) %>% 
  mutate(rank = min_rank(-suicides_no)) %>%
  ungroup()

static_plot<-ggplot(sm3,aes(rank,group=country,fill=as.factor(country),color=as.factor(country))) +
 geom_tile(aes(y = suicides_no/2,height = suicides_no, width = 0.9), alpha = 0.8, color = NA) +
 geom_text(aes(y = 0, label = paste(country, ' ')), vjust = 0.2, hjust = 1) +
 geom_text(aes(y=suicides_no,label = paste(' ',suicides_no)), hjust=0)+
 coord_flip(clip = 'off', expand = TRUE) +
 scale_y_continuous(labels = scales::comma) +
 scale_x_reverse() +
 guides(color = FALSE, fill = FALSE) +
 theme_minimal() +
 theme(
 plot.title=element_text(size=25, hjust=0.5, face='bold', colour='grey', vjust=-1),
 plot.subtitle=element_text(size=18, hjust=0.5, face='italic', color='grey'),
 plot.caption =element_text(size=8, hjust=0.5, face='italic', color='grey'),
 axis.ticks.y = element_blank(), 
 axis.text.y = element_blank(), 
 plot.margin = margin(1,1,1,4, 'cm')
 )

plt<-static_plot + transition_states(states = year, transition_length = 4, state_length = 1) + 
 ease_aes('cubic-in-out') +
 labs(title = 'Total Suicides per Year : {closest_state}', 
 subtitle = 'Top 10 Countries',
 caption = 'Data Source: World Bank Data',
 x='Countries',y='Total Suicides per year')

final_animation<-animate(plt,100,fps = 20,duration = 30, width = 950, height = 750, renderer = gifski_renderer())

final_animation
```


## Inference

```{r,echo=FALSE}
hist(maindata$suicide_per_100k)
suicide = maindata %>% 
  mutate(suicide_per_100k = suicide_per_100k+1)
```


From the distribution plot of suicide_100k_pop, we can see that we need to transform it to satisfy the assumptions for linear model. we used log transformation and changed 0's to 0.01 for further calculations. Following graphs show that after transformation, the distribution has been much more normal than the previous one.

```{r,echo=FALSE}
hist(log(maindata$suicide_per_100k))
```



We chose year, sex, age, $sex*age$ and gdp_per_capita as our predictor for predicting log suicide rate. The reason behind the variable chosen process is that sex, age and GDP were our main interest at the beginning. We used $sex*age$ (the interaction term) because we think age and sex might interact together as effect measure of modifier or confounder. For example women in menopause might have higher suicide rate because of hormonal fluctuation. From the plots, we can see that the residuals are mostly constant but there are 3 clusters(one on the left and two on the right); normality assumption is nearly held; there are about 3 outliers.



```{r,echo=FALSE}
maindata_log_y = maindata %>% 
  mutate(log_suicide =log(suicide_per_100k))
maindata_log_y$log_suicide[is.infinite(maindata_log_y$log_suicide)]=0.01

model1=lm(log_suicide~year+sex*age+gdp_per_capita, data = maindata_log_y)
summary(model1)
```



```{r,echo=FALSE}
par(mfrow=c(2,2))
plot(model1)

```

## Prediction

```{r}
model_try = lm(log_suicide~country+sex+age+population+gdp_per_capita+sex*age, data = maindata_log_y)
anova(model_try)
summary(model_try)$adj.r.squared
par(mfrow=c(2,2))
plot(model_try)
```

For the significance of building a model for prediction, we used adjusted R squared as our criteria of selection. Thus, we built a larger model including country, sex, age, population, gdp_per_capita, and $sex*age$ as our predictors. The adjusted R squared is 0.746 for this model which means 74.6% of the variability of log suicide rate was explained by our model. However, since this model included more variables, so this model might be harder to interpret. From the plots, we can see that the residuals are mostly constantand better than the smaller model; normality assumption is nearly held ; there are about 3 outliers.

# Discussion

## Strength: 
This study is a longitudinal study with a time spin of 30 years, which gives us more chance to explore the justifications and trends behand the data. 

## Limitations: 
First of all, there are only few variables that may related with suicide rate. However, there are other factors or latent factors that may reflected by suicide rate such as alcohol use. 

Secondly, since we have done a global trend analysis, we need data from all over the world. However, this particular data set lacks the suicide information from Asia and  Africa. 

Lastly, the data is not individual-leveled which may intervene our analysis for prediction purpose.


