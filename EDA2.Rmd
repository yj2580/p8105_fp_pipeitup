---
title: "eda"
author: "Yingxi Ji"
date: "11/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
```

# Data cleaning

```{r}
master_2 <- read_csv("~/Desktop/master 2.csv") 

  maindata = master_2 %>% 
  janitor::clean_names() %>%
  select(-("hdi_for_year")) %>%
  mutate(suicideRate = (suicides_no/population)*100, 
         country = as.factor(country),
         age=str_remove(age,"years"),
         gdp_for_year = as.numeric(gsub(",","",gdp_for_year)),
         age_group=as.factor(age),
         suicides_no = as.numeric(suicides_no),
         population = as.numeric(population),
         sex = as.factor(sex),
         generation = as.factor(generation)) 
```

Dropped HDI since this is a index that caclculated every 5 yrs and there are too many missing value. 



## suicide rate accross the age group
```{r}
maindata %>% 
ggplot(aes(x = suicideRate, fill = age, alpha = 0.5)) + 
geom_histogram() + 
facet_wrap(~age) +
labs(title = "Distribution of suicide rates across age groups", x = "Suicide rates")

```

comment:Lots of countries having low suicide rates for the youngest age group; some countries have high suicide rates when it comes to the older age groups.

## Suicide rates over time
```{r}
maindata %>%
  group_by(year) %>%
  summarize(population = sum(population), 
            suicides = sum(suicides_no), 
            suicides_per_100k = (suicides / population) * 100000) %>%
  ggplot(aes(x = year, y = suicides_per_100k, group=1)) + 
  geom_line(col = "deepskyblue3", size = 1) + 
  geom_point(col = "deepskyblue3", size = 2) + 
  labs(title = "Global Suicides (per 100k)",
       subtitle = "Trend over time, 1985 - 2015.",
       x = "Year", 
       y = "Suicides per 100k") 

```

## heat map
```{r}
country <- maindata %>%
  group_by(country) %>% 
  summarise(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000)

countrydata <- joinCountryData2Map(country, joinCode = "NAME", nameJoinColumn = "country")

par(mar=c(0, 0, 0, 0)) # margins

mapCountryData(countrydata, 
nameColumnToPlot="suicide_per_100k", 
mapTitle="", 
colourPalette = "heat", 
oceanCol="skyblue", 
missingCountryCol="grey", 
catMethod = "pretty")
```
lack of the data from Asia and Africa

## suicide by country(interactive plot)
```{r}
interactiveplot = maindata %>%
  select(gdp_per_capita,suicides_100k_pop, suicideRate, year, country,population) %>% 
        ggplot(aes(x = gdp_per_capita, 
                   y = suicideRate,
                   size = population,
                   frame = year,
                   group = country)) +
        geom_point( colour='#1050DC') +
        scale_x_log10() + 
        scale_alpha_continuous(range = c(0.4, 0.8)) + 
        labs(title= "Suicide rates grouped by country from 1985 to 2016") +
#        geom_hline(aes(yintercept = mean(suicides_per_100k)), color="gray") +
        theme_minimal()

plotly = ggplotly(interactiveplot, tooltip = c('country', 'population', 'suicides_per_100k', 'gdp_per_capita'))
plotly
```

## trend with sex

```{r}
maindata%>%
  group_by(year, sex) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000) %>%
  ggplot(aes(x = year, y = suicide_per_100k, col = factor(sex))) + 
  facet_grid(sex ~ ., scales = "free_y") + 
  geom_line() + 
  geom_point() + 
  labs(title = "Trends Over Time, by Sex", 
       x = "Year", 
       y = "Suicides per 100k", 
       color = "Sex") + 
  theme(legend.position = "none") + 
  scale_x_continuous(breaks = seq(1985, 2015, 5), minor_breaks = F)
```

## trend with age

```{r}
maindata %>% 
ggplot(aes(year, suicideRate, color = age)) +
geom_smooth(method = "lm") +
labs(y = "Suicide rate", title = "Suicide rates over time")

```

Suicide rates for the youngest age group nearly constant  and low over time. The rate drops but it may caused by decrease in population. 

## suicide rate with living standard 

```{r}
maindata%>% 
group_by(country) %>% 
summarize(count = n(), medianSuicides = median(suicides_no))  %>% 
mutate(country = fct_reorder(country, medianSuicides)) %>% 
top_n(20) %>% 
ungroup() %>% 
ggplot(aes(country, medianSuicides)) + 
geom_col(aes(fill = country)) +
coord_flip() +
labs(title = "Median number of suicides per country", x = "Country", y = "Median suicides")
```

Since we see that both US and Japan have high median suicide, the standard living and suicides have a negative relationship. 


## modeling

### EDA
### correlation for numeric variables

From the correlation plot on numeric variables, we can see that there are correlation between gdp for year, gdp per capita and population because the calculation of gdp per capita. Thus, in the model we included both gdp indicators but not the population because we think these two represents different things for comparison between countries.

```{r}
library(corrplot)

corr_data = maindata %>% 
  select(-c(1,3,4,8,11,12,13)) 
corr= cor(corr_data)
corrplot(corr, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```

```{r}
summary(maindata)
hist(maindata$suicides_100k_pop)
suicide = maindata %>% 
  mutate(suicides_100k_pop = suicides_100k_pop+1)

hist(log(maindata$suicides_100k_pop))
plot(suicides_100k_pop~gdp_for_year, data=maindata)
```

From the distribution plot of suicide_100k_pop, we can see that we need to transform it to satisfy the assumptions for linear model. we used log transformation and changed 0's to 0.01 for further calculations. Also, gdp_for_year needs transformation.

### transformed gdp_for_year 
after saw the correlation plot above

```{r}
plot(suicides_100k_pop~log(gdp_for_year), data=maindata)
```

### bigger model

After correlation plots, we decided to keep the following variables:

```{r}
maindata_try = maindata %>% 
  mutate(log_suicide =log(suicides_100k_pop))
maindata_try$log_suicide[is.infinite(maindata_try$log_suicide)]=0.01

model1=lm(log_suicide~log(gdp_for_year)+year+sex+age_group+gdp_for_year+gdp_per_capita, data = maindata_try)

plot(model1)
summary(model1)
```

The residual is better for this model than the model for BSS.

## model by best subset selection

```{r}
datatry= maindata_try %>% select(sex, age_group, suicides_no, log_suicide, gdp_for_year, gdp_per_capita, population)

library(leaps)
full_reg = regsubsets(log_suicide~., data= datatry)
full_sum = summary(full_reg)


```

```{r}
library(ggvis)
rsq <- as.data.frame(full_sum$adjr2)
names(rsq) <- "R2"
rsq %>% 
        ggvis(x=~ c(1:nrow(rsq)), y=~R2 ) %>%
        layer_points(fill = ~ R2 ) %>%
        add_axis("y", title = "R2") %>% 
        add_axis("x", title = "Number of variables")

plot(full_reg,scale="adjr2")
```
By using $R^2$ as the criteria, BSS chose the model above.

```{r}
model_try = lm(log_suicide~sex+age_group+ suicides_no+ gdp_per_capita+ population, data = datatry)
summary(model_try)
plot(model_try)
```

after selection r squared increased a little but the residual plot was worse than before. We can choose this model because the model only keeps one of the two indicators for GDP.

### prediction for US

```{r}
us=maindata_try %>% filter(country=="United States")
hist(us$log_suicide)
modelus=lm(log_suicide~gdp_for_year+sex+age_group+gdp_per_capita, data = us)

summary(modelus)
plot(modelus)

# prediction for 25-34 male suicide rate in US
#sqrt(log(2.14*(10^13))*(-0.059)+1*0.07176+0.01109+65112*0.000001792+1.648)


```
The model has high R^2 but the residual plot was not good.


```{r}
country_mean_gdp <- maindata %>%
  group_by(country) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000, 
            gdp_per_capita = mean(gdp_per_capita))

ggplot(country_mean_gdp, aes(x = gdp_per_capita, y = suicide_per_100k)) + 
  geom_point() + 
  scale_x_continuous(labels=scales::dollar_format(prefix="$"), breaks = seq(0, 70000, 10000)) + 
  labs(title = "Correlation between GDP (per capita) and Suicides per 100k", 
       subtitle = "Plot containing every country",
       x = "GDP (per capita)", 
       y = "Suicides per 100k") 

model_gdp <- lm(suicide_per_100k ~ gdp_per_capita, data = country_mean_gdp)

gdp_suicide_no_outliers <- model_gdp %>%
  augment() %>%
  arrange(desc(.cooksd)) %>%
  filter(.cooksd < 4/nrow(.)) %>% # removes 5/93 countries
  inner_join(country_mean_gdp, by = c("suicide_per_100k", "gdp_per_capita")) 

model_gdp_ad <- lm(suicide_per_100k ~ gdp_per_capita, data = gdp_suicide_no_outliers)

summary(model_gdp_ad)


ggplot(gdp_suicide_no_outliers, aes(x = gdp_per_capita, y = suicide_per_100k)) + 
  geom_point() + 
  geom_smooth(method = "lm", aes(group = 1)) + 
  scale_x_continuous(labels=scales::dollar_format(prefix="$"), breaks = seq(0, 70000, 10000)) + 
  labs(title = "Correlation between GDP per capita and Suicides per 100k", 
       subtitle = "Plot with high CooksD countries removed (5/93 total)",
       x = "GDP per capita", 
       y = "Suicides per 100k", 
       col = "Continent") + 
  theme(legend.position = "none")
```

There is weak positive relationship between GDP per capita and suicides per 100k after we removed outliers.






# suicide prevention link
https://en.wikipedia.org/wiki/List_of_suicide_crisis_lines






