---
title: "code_backplan"
author: "Yiling Yang"
date: "11/30/2019"
output: html_document
---

## suicide rate accross the age group
```{r}
maindata %>% 
ggplot(aes(x = suicideRate, fill = age, alpha = 0.5)) + 
geom_histogram() + 
facet_wrap(~age) +
labs(title = "Distribution of suicide rates across age groups", x = "Suicide rates")
```

comment:Lots of countries having low suicide rates for the youngest age group; some countries have high suicide rates when it comes to the older age groups

```{r,echo=FALSE,message=FALSE,warning=FALSE}
# map
country <- maindata %>%
  group_by(country) %>% 
  summarise(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000)

countrydata <- joinCountryData2Map(country, joinCode = "NAME", nameJoinColumn = "country")

#par(mar=c(0, 0, 0, 0)) # margins

mapCountryData(countrydata, 
               nameColumnToPlot="suicide_per_100k", 
               mapTitle="", 
               colourPalette = "heat", 
               oceanCol="skyblue", 
               missingCountryCol="grey", 
               catMethod = "pretty")
```


```{r}
# bar for total
maindata%>% 
  group_by(country) %>% 
  summarize(count = n(), medianSuicides = median(suicides_no))  %>% 
  mutate(country = fct_reorder(country, medianSuicides)) %>% 
  top_n(20) %>% 
  ungroup() %>% 
  ggplot(aes(country, medianSuicides)) + 
  geom_col(aes(fill = country)) +
  coord_flip() +
  labs(title = "Median number of suicides per country", x = "Country", y = "Median suicides")
```

```{r}
interactiveplot = maindata %>%
  select(gdp_per_capita,suicides_100k_pop, year, country,population) %>% 
        ggplot(aes(x = gdp_per_capita, 
                   y = suicides_100k_pop,
                   size = population,
                   frame = year,
                   group = country)) +
        geom_point(colour='#1050DC') +
        scale_x_log10() + 
        scale_alpha_continuous(range = c(0.4, 0.8)) + 
        labs(title= "Suicide rates grouped by country from 1985 to 2016") +
#        geom_hline(aes(yintercept = mean(suicides_per_100k)), color="gray") +
        theme_minimal() +
        xlab("GDP") +
        ylab("Suicide Rate")
```


# Model

### correlation for numeric variables

```{r}
# From the correlation plot on numeric variables, we can see that there are correlation between gdp for year, gdp per capita and population because the calculation of gdp per capita. Thus, in the model we included both gdp indicators but not the population because we think these two represents different things for comparison between countries.

# cannot run 
# errir nessgae:  Error in cor(corr_data) : 'x' must be numeric
#corr_data = maindata %>% 
#  select(-c(1,3,4,8,11,12,13)) 
#corr= cor(corr_data)
#corrplot(corr, type = "upper", order = "hclust", 
#         tl.col = "black", tl.srt = 45)
```
## model by best subset selection

```{r}
datatry= maindata_try %>% select(sex, age_group, suicides_no, log_suicide, gdp_for_year, gdp_per_capita, population)

full_reg = regsubsets(log_suicide~., data= datatry)
full_sum = summary(full_reg)
```

```{r}
rsq <- as.data.frame(full_sum$adjr2)
names(rsq) <- "R2"
rsq %>% 
        ggvis(x=~ c(1:nrow(rsq)), y=~R2 ) %>%
        layer_points(fill = ~ R2 ) %>%
        add_axis("y", title = "R2") %>% 
        add_axis("x", title = "Number of variables")

plot(full_reg,scale="adjr2")
```
By using $R^2$ as the criteria, BSS chose the model above.

```{r}
model_try = lm(log_suicide~sex+age_group+ suicides_no+ gdp_per_capita+ population, data = datatry)
summary(model_try)
plot(model_try)
```

after selection r squared increased a little but the residual plot was worse than before. We can choose this model because the model only keeps one of the two indicators for GDP.

### prediction for US

```{r}
us=maindata_try %>% filter(country=="United States")
hist(us$log_suicide)
modelus=lm(log_suicide~gdp_for_year+sex+age_group+gdp_per_capita, data = us)

summary(modelus)
plot(modelus)

# prediction for 25-34 male suicide rate in US
#sqrt(log(2.14*(10^13))*(-0.059)+1*0.07176+0.01109+65112*0.000001792+1.648)


```
The model has high R^2 but the residual plot was not good.


```{r}
country_mean_gdp <- maindata %>%
  group_by(country) %>%
  summarize(suicide_per_100k = (sum(as.numeric(suicides_no)) / sum(as.numeric(population))) * 100000, 
            gdp_per_capita = mean(gdp_per_capita))

ggplot(country_mean_gdp, aes(x = gdp_per_capita, y = suicide_per_100k)) + 
  geom_point() + 
  scale_x_continuous(labels=scales::dollar_format(prefix="$"), breaks = seq(0, 70000, 10000)) + 
  labs(title = "Correlation between GDP (per capita) and Suicides per 100k", 
       subtitle = "Plot containing every country",
       x = "GDP (per capita)", 
       y = "Suicides per 100k") 

model_gdp <- lm(suicide_per_100k ~ gdp_per_capita, data = country_mean_gdp)

gdp_suicide_no_outliers <- model_gdp %>%
  augment() %>%
  arrange(desc(.cooksd)) %>%
  filter(.cooksd < 4/nrow(.)) %>% # removes 5/93 countries
  inner_join(country_mean_gdp, by = c("suicide_per_100k", "gdp_per_capita")) 

model_gdp_ad <- lm(suicide_per_100k ~ gdp_per_capita, data = gdp_suicide_no_outliers)

summary(model_gdp_ad)


ggplot(gdp_suicide_no_outliers, aes(x = gdp_per_capita, y = suicide_per_100k)) + 
  geom_point() + 
  geom_smooth(method = "lm", aes(group = 1)) + 
  scale_x_continuous(labels=scales::dollar_format(prefix="$"), breaks = seq(0, 70000, 10000)) + 
  labs(title = "Correlation between GDP per capita and Suicides per 100k", 
       subtitle = "Plot with high CooksD countries removed (5/93 total)",
       x = "GDP per capita", 
       y = "Suicides per 100k", 
       col = "Continent") + 
  theme(legend.position = "none")
```

There is weak positive relationship between GDP per capita and suicides per 100k after we removed outliers.
